{% extends 'account/base.html' %}
{% block main-content %}
{% load static %}
<style>
    .error {
        color: #FF0000;
    }
    .hidden {
       display: none;
    }

    / Custom Styles /
    .search-form {
        display: flex;
        align-items: center;
    }

    .search-input {
        width: 150px; / Adjust size as needed /
    }
    .container-xxl
    {
    margin-left:260px;
    margin-top:-520px;
    width:1100px;
    }
</style>
<div class="container-xxl">
    <div class="card">
       <div class="card-header border-0 pt-6 d-flex justify-content-between align-items-center">
    <form class="search-form" action="http://127.0.0.1:8000/in-out/" method="get">

             <div class="input-group" style="width:150px;">

                    <input type="text"   data-kt-customer-table-filter="search" id="searchInput" value="" name="searchInput" class="form-control form-control-solid search-input" placeholder="Search Employee" fdprocessedid="3pql1a">
             </div>
             <div style="margin-top:-39px;margin-left:152px;" >
                 <button  class="button" class="button:hover" class="btn btn-primary ml-2 search-button" type="submit" name="searchButton" id="searchButton" fdprocessedid="48081" onclick="searchInOut()">Search</button>
             </div>
    </form>
    <div class="card-title">
        <h3 class="page-title d-flex align-items-center flex-wrap me-20 mb-300 mb-lg-0">Employee Request list</h3>
    </div>
    <div class="card-toolbar">
                <div class="menu menu-sub menu-sub-dropdown w-300px w-md-325px" data-kt-menu="true"
                     id="kt-toolbar-filter"></div>
                <button type="button" class="button" class="button:hover" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#kt_modal_add_customer" fdprocessedid="hrjq6j"><a href="{% url 'add-in-out' %}" class="text-white" style="text-decoration:none;">Add Request</a>
                </button>
    </div>
</div>

        <div class="new" id="salarysearch">
            <div class="card-body pt-0">
                <div id="kt_customers_table_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                    <div class="table-responsive">
                        <table class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer" id="kt_customers_table">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Name</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Date</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Type</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Reason</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Approvel-Status</th>
                                    <th class="text-end min-w-70px sorting_disabled" style="width: 133.062px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600" id="inOutTableBody">
                                  <tr>There are no records found.</tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/js/all.min.js" integrity="sha512-gIQwP4/Kf6XJOhVfgPWcHvQLihsjyBFRczY3R9jOP3eeVDYyjIF4oCEVWfLCd4bEoJNv1wVapcG8dbtq5jTehw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>

        // Function to fetch data from API and populate the table
    function fetchDataAndPopulateTable() {
    fetch('http://127.0.0.1:8000/in-out/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            const tableBody = document.querySelector('#kt_customers_table tbody');

            // Clear existing table rows
            tableBody.innerHTML = '';

            // Populate table rows with data
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                row.id = `inOutRequestRow${record.id}`; // Set unique ID for each row
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.date}</td>
                    <td>${record.type}</td>
                    <td>${record.reason}</td>
                    <td>${record.approvel_status}</td>
                    <td style="display:inline-flex; align-items:center; margin-right:10px">
                        <button class="btn btn-primary" onclick="updateRecord(${record.id})">Update</button>
                        <button class="btn btn-danger" onclick="deleteRecord(${record.id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching records:', error));
}

    // Call the function to fetch data and populate the table when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        fetchDataAndPopulateTable();
    });

     function deleteRecord(requestId) {
    // Send delete request using AJAX
    $.ajax({
        url: `http://127.0.0.1:8000/in-out/${requestId}/`,
        type: 'DELETE',
        success: function(response) {
            // Remove the corresponding row from the UI
            const row = document.getElementById(`inOutRequestRow${requestId}`);
            if (row) {
                row.remove();
                console.log(`In-out request with ID ${requestId} deleted successfully`);
            } else {
                console.error(`Failed to find in-out request row with ID ${requestId}`);
            }
        },
        error: function(xhr, status, error) {
            console.error(`Failed to delete in-out request with ID ${requestId}: ${error}`);
        }
    });
}

function searchInOut() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const inOutTableBody = document.getElementById('inOutTableBody');

        // Fetch data from API
        fetch('http://127.0.0.1:8000/in-out/')
            .then(response => response.json())
            .then(data => {
                // Clear existing table rows
                inOutTableBody.innerHTML = '';

                // Filter data based on search term
                const filteredData = data.filter(record => record.name.toLowerCase().includes(searchTerm));

                // Populate table rows with filtered data
                filteredData.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.id = `inOutRequestRow${record.id}`;
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.date}</td>
                        <td>${record.type}</td>
                        <td>${record.reason}</td>
                        <td>${record.approvel_status}</td>
                        <td style="display:inline-flex; align-items:center; margin-right:10px">
                            <button class="btn btn-primary" onclick="updateRecord(${record.id})">Update</button>
                            <button class="btn btn-danger" onclick="deleteRecord(${record.id})">Delete</button>
                        </td>
                    `;
                    inOutTableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching in-out records:', error));
    }

    // Prevent default form submission behavior and call searchInOut() function
    document.querySelector('.search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        searchInOut();
    });
</script>
{% endblock main-content %}