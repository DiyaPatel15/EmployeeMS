{% extends 'account/base.html' %}
{% block main-content %}
{% load static %}
<style>
    .error {
        color: #FF0000;
    }
    .hidden {
       display: none;
    }

    / Custom Styles /
    .search-form {
        display: flex;
        align-items: center;
    }

    .search-input {
        width: 150px; / Adjust size as needed /
    }
    .container-xxl
    {
      margin-left:-100px;
      margin-top:110px;
      width:1100px;
      font-size:13px;
    }
</style>
<div class="container-xxl">
    <div class="card">
       <div class="card-header border-0 pt-6 d-flex justify-content-between align-items-center">
    <form class="search-form" action="http://127.0.0.1:8000/in-out/" method="get">

             <div class="input-group" style="width:150px;">

                    <input type="text" style="font-size:13px;"  data-kt-customer-table-filter="search" id="searchInput" value="" name="searchInput" class="form-control form-control-solid search-input" placeholder="Search Employee" fdprocessedid="3pql1a">
             </div>
             <div style="margin-top:-39px;margin-left:152px;">
                 <button style="font-size:13px;"  class="button" class="button:hover" class="btn btn-primary ml-2 search-button" type="submit" name="searchButton" id="searchButton" fdprocessedid="48081" onclick="searchInOut()">Search</button>
             </div>
    </form>
    <div class="card-title">
        <h3 class="page-title d-flex align-items-center flex-wrap me-20 mb-300 mb-lg-0" style="font-size:22px;">Employee Request list</h3>
    </div>
    <div class="card-toolbar">
                <div class="menu menu-sub menu-sub-dropdown w-300px w-md-325px" data-kt-menu="true"
                     id="kt-toolbar-filter"></div>
                <button type="button" class="button" class="button:hover" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#kt_modal_add_customer" fdprocessedid="hrjq6j"><a href="{% url 'add-in-out' %}" class="text-white" style="text-decoration:none;font-size:13px;">Add Request</a>
                </button>
    </div>
</div>

        <div class="new" id="salarysearch">
            <div class="card-body pt-0">
                <div id="kt_customers_table_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                    <div class="table-responsive">
                        <table class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer" id="kt_customers_table">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Name</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Date</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Type</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Reason</th>
                                    <th class="min-w-125px sorting" style="width: 171.516px;">Approvel-Status</th>
                                    <th class="text-end min-w-70px sorting_disabled" style="width: 133.062px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600" id="inOutTableBody">
                                  <tr></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Update Record</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    <input type="hidden" id="recordId" name="recordId">
                    <div class="form-group">
                        <label for="updateDate">NAME:</label>
                        <input type="text" class="form-control" id="updateName" name="updateName">
                    </div>
                    <div class="form-group">
                        <label for="updateDate">DATE:</label>
                        <input type="date" class="form-control" id="updateDate" name="updateDate">
                    </div>
                    <div class="form-group">
                        <label for="updateType">TYPE:</label>
                        <select class="form-control" id="updateType" name="updateType">
                            <option value="In">In</option>
                            <option value="Out">Out</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="updateReason">REASON:</label>
                        <input type="text" class="form-control" id="updateReason" name="updateReason">
                    </div>
                    <div class="form-group">
                        <label for="updateStatus">APPROVAL STATUS:</label>
                        <select class="form-control" id="updateStatus" name="updateStatus">
                            <option value="Accepted">Accepted</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>

                    <button type="submit" class= "button" class="button:hover" class="btn btn-primary" style="display: block;margin: 0 auto;" onclick="submitForm()">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>


<script>

        // Function to fetch data from API and populate the table
    function fetchDataAndPopulateTable() {
    fetch('http://127.0.0.1:8000/in-out/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            const tableBody = document.querySelector('#kt_customers_table tbody');

            // Clear existing table rows
            tableBody.innerHTML = '';

            // Populate table rows with data
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                row.id = `inOutRequestRow${record.id}`; // Set unique ID for each row
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.date}</td>
                    <td>${record.type}</td>
                    <td>${record.reason}</td>
                    <td>${record.approvel_status}</td>
                    <td>
                        <button class="btn btn-danger text-danger . bg-light" onclick="toggleActionMenu(${record.id})">...</button>
                        <div id="actionMenu_${record.id}" class="action-menu hidden mt-2">
                            <button class="btn btn-primary text-primary . bg-light"  onclick="updateRecord(${record.id})">Update</button>
                            <button class="btn btn-danger text-danger . bg-light" style="margin-right:-200px" onclick="deleteRecord(${record.id})">Delete</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching records:', error));
}

             function toggleActionMenu(recordId) {
                                const actionMenu = document.getElementById(`actionMenu_${recordId}`);
                                if (actionMenu.classList.contains('hidden')) {
                                    actionMenu.classList.remove('hidden');
                                } else {
                                    actionMenu.classList.add('hidden');
                                }
             }

             function clickOutsideHandler(e) {
                    if (!actionMenu.contains(e.target) && !actionButton.contains(e.target)) {
                         actionMenu.classList.add('hidden');
                            // Remove event listener after closing action menu
                         document.removeEventListener('click', clickOutsideHandler);
                    }
             }
             // Call the function to fetch data and populate the table when the document is ready
             document.addEventListener('DOMContentLoaded', function() {
                    fetchDataAndPopulateTable();
             });

     function deleteRecord(requestId) {
    // Send delete request using AJAX
    $.ajax({
        url: `http://127.0.0.1:8000/in-out/${requestId}/`,
        type: 'DELETE',
        success: function(response) {
            // Remove the corresponding row from the UI
            const row = document.getElementById(`inOutRequestRow${requestId}`);
            if (row) {
                row.remove();
                console.log(`In-out request with ID ${requestId} deleted successfully`);
            } else {
                console.error(`Failed to find in-out request row with ID ${requestId}`);
            }
        },
        error: function(xhr, status, error) {
            console.error(`Failed to delete in-out request with ID ${requestId}: ${error}`);
        }
    });
}

function searchInOut() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const inOutTableBody = document.getElementById('inOutTableBody');

        // Fetch data from API
        fetch('http://127.0.0.1:8000/in-out/')
            .then(response => response.json())
            .then(data => {
                // Clear existing table rows
                inOutTableBody.innerHTML = '';

                // Filter data based on search term
                const filteredData = data.filter(record => record.name.toLowerCase().includes(searchTerm));

                // Populate table rows with filtered data
                filteredData.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.id = `inOutRequestRow${record.id}`;
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.date}</td>
                        <td>${record.type}</td>
                        <td>${record.reason}</td>
                        <td>${record.approvel_status}</td>

                        <td>
                            <button class="btn btn-danger text-danger . bg-light" onclick="toggleActionMenu(${record.id})">...</button>
                            <div id="actionMenu_${record.id}" class="action-menu hidden mt-2">
                                <button class="btn btn-primary text-primary . bg-light"  onclick="updateRecord(${record.id})">Update</button>
                                <button class="btn btn-danger text-danger . bg-light" style="margin-right:-200px" onclick="deleteRecord(${record.id})">Delete</button>
                            </div>
                        </td>
                    `;
                    inOutTableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching in-out records:', error));
    }

    // Prevent default form submission behavior and call searchInOut() function
    document.querySelector('.search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        searchInOut();
    });


     function updateRecord(recordId) {
        console.log('Update button clicked for record ID:', recordId);
        // Fetch the record data
        fetch(`http://127.0.0.1:8000/in-out/${recordId}/`)
            .then(response => response.json())
            .then(data => {
                // Populate the form fields with record data
                document.getElementById('recordId').value = data.id;
                document.getElementById('updateName').value = data.name;
                document.getElementById('updateDate').value = data.date;
                document.getElementById('updateType').value = data.type;
                document.getElementById('updateReason').value = data.reason;
                document.getElementById('updateStatus').value = data.approvel_status;

                // Show the update modal
                $('#updateModal').modal('show');
            })
            .catch(error => console.error('Error fetching record:', error));
    }

    // Function to submit the update form data via AJAX
    function submitForm() {
        event.preventDefault();
        const recordId = $('#recordId').val();
        const updatedName = $('#updateName').val();
        const updatedDate = $('#updateDate').val();
        const updatedType = $('#updateType').val();
        const updatedReason = $('#updateReason').val();
        const updatedStatus = $('#updateStatus').val();

        fetch(`http://127.0.0.1:8000/in-out/${recordId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: updatedName,
                date: updatedDate,
                type: updatedType,
                reason: updatedReason,
                approvel_status: updatedStatus // Corrected spelling here
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update record');
                }
                console.log('Record updated successfully');
                // Close the update modal
                $('#updateModal').modal('hide');
                // Refresh record data in the table
                fetchDataAndPopulateTable(); // You need to define this function to fetch and populate records
            })
            .catch(error => console.error('Error updating record:', error));
    }
</script>
{% endblock main-content %}